<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Publicaciones</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- ============ LOGIN VIEW ============ -->
  <div id="login-view" class="login-page">
    <div class="login-box">
      <div class="login-box__header">
        <div class="login-box__icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </div>
        <h1 class="login-box__title">Panel de Administracion</h1>
        <p class="login-box__subtitle">Ingresa tus credenciales para continuar</p>
      </div>

      <form id="login-form">
        <div class="form-group">
          <label class="form-label" for="login-user">Usuario</label>
          <div class="form-input-wrap">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <input id="login-user" type="text" class="form-input form-input--with-icon" placeholder="admin" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="login-pass">Contrasena</label>
          <div class="form-input-wrap">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <input id="login-pass" type="password" class="form-input form-input--with-icon" placeholder="&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;&#8226;" required>
          </div>
        </div>

        <p id="login-error" class="form-error" hidden></p>

        <button type="submit" class="btn btn--primary" id="login-btn">Iniciar Sesion</button>
      </form>

      <p class="login-box__hint">Usuario: admin / Contrasena: admin123</p>
    </div>
  </div>

  <!-- ============ ADMIN DASHBOARD VIEW ============ -->
  <div id="admin-view" hidden>

    <!-- Admin Header -->
    <header class="admin-header">
      <div class="container">
        <div class="admin-header__brand">
          <div class="admin-header__icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
          </div>
          <h1 class="admin-header__title">Panel Admin</h1>
        </div>
        <div class="admin-header__actions">
          <a href="index.html">Ver sitio</a>
          <button class="btn btn--ghost" id="logout-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1rem;height:1rem"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
            <span>Salir</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Admin Content -->
    <main class="container admin-content">
      <div class="admin-grid">

        <!-- Form Panel -->
        <div class="admin-form-panel">
          <h2 class="admin-form-panel__title">Nueva Publicacion</h2>

          <form id="pub-form">
            <div class="form-group">
              <label class="form-label" for="pub-title">Titulo</label>
              <input id="pub-title" type="text" class="form-input" placeholder="Titulo de la publicacion" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="pub-desc">Descripcion</label>
              <textarea id="pub-desc" class="form-textarea" rows="4" placeholder="Describe tu publicacion..." required></textarea>
            </div>

            <div class="form-group">
              <label class="form-label" for="pub-cat">Categoria</label>
              <select id="pub-cat" class="form-select">
                <option value="General">General</option>
                <option value="Noticias">Noticias</option>
                <option value="Proyectos">Proyectos</option>
                <option value="Eventos">Eventos</option>
                <option value="Blog">Blog</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Imagen (opcional)</label>
              <div id="upload-zone" class="upload-zone">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" x2="22" y1="5" y2="5"/><line x1="19" x2="19" y1="2" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                <span>Click para subir imagen</span>
              </div>
              <div id="upload-preview" class="upload-preview" hidden>
                <img id="preview-img" src="" alt="Preview">
                <button type="button" id="remove-img" class="upload-preview__remove">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
              </div>
              <input type="file" id="file-input" accept="image/*" class="sr-only">
            </div>

            <button type="submit" class="btn btn--primary" id="pub-submit-btn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:1rem;height:1rem"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
              <span>Publicar</span>
            </button>
          </form>
        </div>

        <!-- Publications List -->
        <div>
          <div class="admin-list-header">
            <h2>Publicaciones</h2>
            <span class="admin-list-count" id="pub-count">0 total</span>
          </div>

          <div id="admin-list" class="admin-pub-list"></div>

          <div id="admin-empty" class="admin-empty" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
            <p class="admin-empty__title">Sin publicaciones</p>
            <p class="admin-empty__desc">Crea tu primera publicacion desde el formulario</p>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let publications = [];
    let selectedFile = null;

    // ---- Helpers ----
    function formatDate(iso) {
      return new Date(iso).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // ---- Auth ----
    function showAdmin() {
      document.getElementById('login-view').hidden = true;
      document.getElementById('admin-view').hidden = false;
      loadPublications();
    }

    function showLogin() {
      document.getElementById('login-view').hidden = false;
      document.getElementById('admin-view').hidden = true;
    }

    // Check session on load
    async function checkAuth() {
      try {
        const res = await fetch(API_BASE + '/api/auth/check');
        if (res.ok) {
          showAdmin();
        }
      } catch {}
    }

    // Login form
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorEl = document.getElementById('login-error');
      errorEl.hidden = true;
      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Cargando...';

      try {
        const res = await fetch(API_BASE + '/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: document.getElementById('login-user').value,
            password: document.getElementById('login-pass').value,
          }),
        });

        if (!res.ok) {
          const data = await res.json();
          errorEl.textContent = data.error || 'Credenciales incorrectas';
          errorEl.hidden = false;
          return;
        }

        showAdmin();
      } catch {
        errorEl.textContent = 'Error de conexion';
        errorEl.hidden = false;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Iniciar Sesion';
      }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await fetch(API_BASE + '/api/auth', { method: 'DELETE' });
      showLogin();
    });

    // ---- Publications ----
    async function loadPublications() {
      try {
        const res = await fetch(API_BASE + '/api/publications');
        publications = await res.json();
      } catch {
        publications = [];
      }
      renderAdminList();
    }

    function renderAdminList() {
      const list = document.getElementById('admin-list');
      const empty = document.getElementById('admin-empty');
      document.getElementById('pub-count').textContent = publications.length + ' total';

      if (publications.length === 0) {
        list.innerHTML = '';
        empty.hidden = false;
        return;
      }

      empty.hidden = true;
      list.innerHTML = publications.map(pub => `
        <div class="admin-pub-item">
          ${pub.image ? `<img class="admin-pub-item__img" src="${pub.image}" alt="${pub.title}">` : ''}
          <div class="admin-pub-item__content">
            <h3 class="admin-pub-item__title">${pub.title}</h3>
            <p class="admin-pub-item__desc">${pub.description}</p>
            <div class="admin-pub-item__meta">
              <span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>
                ${pub.category}
              </span>
              <span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                ${formatDate(pub.createdAt)}
              </span>
            </div>
          </div>
          <div class="admin-pub-item__delete">
            <button class="btn btn--icon" onclick="deletePub('${pub.id}')" aria-label="Eliminar ${pub.title}" style="opacity:1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    async function deletePub(id) {
      try {
        await fetch(API_BASE + '/api/publications', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id }),
        });
        loadPublications();
      } catch {}
    }

    // ---- File Upload ----
    const uploadZone = document.getElementById('upload-zone');
    const uploadPreview = document.getElementById('upload-preview');
    const previewImg = document.getElementById('preview-img');
    const fileInput = document.getElementById('file-input');
    const removeImg = document.getElementById('remove-img');

    uploadZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = () => {
          previewImg.src = reader.result;
          uploadZone.hidden = true;
          uploadPreview.hidden = false;
        };
        reader.readAsDataURL(file);
      }
    });

    removeImg.addEventListener('click', () => {
      selectedFile = null;
      fileInput.value = '';
      previewImg.src = '';
      uploadZone.hidden = false;
      uploadPreview.hidden = true;
    });

    // ---- Publish Form ----
    document.getElementById('pub-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('pub-submit-btn');
      btn.disabled = true;

      try {
        let imagePath = null;

        if (selectedFile) {
          const formData = new FormData();
          formData.append('file', selectedFile);
          const uploadRes = await fetch(API_BASE + '/api/upload', { method: 'POST', body: formData });
          if (uploadRes.ok) {
            const data = await uploadRes.json();
            imagePath = data.path;
          }
        }

        const res = await fetch(API_BASE + '/api/publications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: document.getElementById('pub-title').value,
            description: document.getElementById('pub-desc').value,
            category: document.getElementById('pub-cat').value,
            image: imagePath,
          }),
        });

        if (res.ok) {
          document.getElementById('pub-title').value = '';
          document.getElementById('pub-desc').value = '';
          document.getElementById('pub-cat').value = 'General';
          selectedFile = null;
          fileInput.value = '';
          previewImg.src = '';
          uploadZone.hidden = false;
          uploadPreview.hidden = true;
          loadPublications();
        }
      } catch {}
      finally {
        btn.disabled = false;
      }
    });

    // Init
    checkAuth();
  </script>

</body>
</html>
